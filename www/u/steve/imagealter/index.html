
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<title>Image Alter: Client Side Image Processor</title>

<link type="text/css" rel="stylesheet" href="http://yui.yahooapis.com/3.0.0/build/cssfonts/fonts-min.css" />
<link rel="stylesheet" type="text/css" href="style.css">
<script type="text/javascript" src="http://yui.yahooapis.com/3.0.0/build/yui/yui-min.js"></script>
<script type="text/javascript" src="http://bp.yahooapis.com/2.4.21/browserplus-min.js"></script>  
<script src="http://bp.yahooapis.com/toolbox/installer/1.0.11/install-min.js"></script> 
</head>

<body class=" yui-skin-sam">
<div id="content">
<h1>Client Side Image Processing</h1>

<div class="intro">
	<p>
	    Your servers are busy enough already!  Use ImageAlter from BrowserPlus to perform
	    client-side image transformations.  To start, drag an image from the desktop and drop it on the
	    area below.  Once you do, a list of transformations will appear.  You can apply the transformations
	    more than once.
	</p>
</div>


<div id="play">
    <div id="lists">
        <ul id="choose"></ul>
        <ul id="apply"><div id="applytext"></div></ul>
    </div>
    <div id="imagewell">
        <div id="imagetext"></div>
        <div id="image"></div>
    </div>
</div>

<div id="detail">
    <div id="funcintro">
        <h2>ImageAlter 4</h2>
        <p>
            Starting with 4.0, ImageAlter is built on <a href="http://www.graphicsmagick.org/">GraphicsMagick</a>.
            As a result, the ImageAlter service weighs in at 700KB, compared to ImageAlter3's 1.4MB.
            ImageAlter4's API has changed, allow for chainable transformations and is now
            <a href="http://github.com/lloyd/bp-imagealter">open source</a>.  
            
        <p>
            Can't find the transformation you <em>need</em>?  
            With A little C++ knowledge, you can always 
            <a href="http://github.com/lloyd/bp-imagealter/blob/master/src/Transformations.cpp">add it yourself</a>.
        </p>
    </div>

    <h3>ImageAlter in action:</h3>

    <pre>
BrowserPlus.ImageAlter.transform({
        file: &lt;path&gt;, 
        <em>format: "png"</em>, 
        <em>quality: 100</em>, 
        <em>actions:[{"scale": [0.2, 0.2, 0.8, 0.8]}, "enhance", "grayscale", {"contrast": 2}]</em>
    }, 
    function(result){});</pre>


    <h3>ImageAlter API</h3>
    <dl id="filterdoc">
        <dt>file: path (req)</dt>
	    <dd>The image to transform.</dd>

        <dt>format: string (opt)</dt>
	    <dd>
	        The format of the output image. Default is to output in the same format as the input image. 
	        A string, one of: jpg, gif, or png
	    </dd>

        <dt>quality: integer (opt)</dt>
        <dd>
	        The quality of the output image. From 0-100. Lower qualities result in faster operations 
	        and smaller file sizes, at the cost of image quality.
	    </dd>

        <dt>actions: list (opt)</dt>
	    <dd>
	        <p>
	            An array of actions to perform. Each action is either a string 
	            (i.e. { actions: [ 'solarize' ]	}) , or an object with a single property, where the 
	            property name is the action to perform, and the property value is the argument 
	            (i.e. { actions: [{rotate: 90}] }. 
            </p>
            <p>
	            Supported actions include: 
	        </p>

            <dl>
                <dt>contrast - <span>actions: [{'contrast': 1}]</span></dt>
                <dd>
                    adjust the image's contrast, accepts an optional numeric argument between -10 and 10
                </dd> 
                <dt>crop - <span>actions: [{'crop': [0.1, 0.1, 0.9, 0.9]}]</span></dt>
                <dd>
                    select a subset of an image, accepts an array of four floating point numbers: 
                    x1,y1,x2,y2 which are between 0.0 and 1.0 and are relative coordinates to the 
                    upper left hand corner of the image
                </dd>
                <dt>despeckle - <span>actions: ['despeckle']</span></dt>
                <dd>
                    reduces the speckle noise in an image while preserving the edges of the original 
                    image, accepts no arguments
                </dd>
                <dt>enhance - <span>actions: ['enhance']</span></dt>
                <dd>
                    Applies a digital filter that improves the quality of a noisy image, accepts no arguments
                </dd>
                <dt>grayscale - <span>actions: ['grayscale']</span></dt>
                <dd>remove the color from an image, accepts no arguments</dd>
                <dt>greyscale - <span>actions: ['greyscale']</span></dt>
                <dd>an alias for 'grayscale'</dd>
                <dt>negate - <span>actions: ['negate']</span></dt>
                <dd>negate the colors of the image, accepts no arguments</dd>
                <dt>noop - <span>actions: ['noop']</span></dt>
                <dd>do nothing. may be applied multiple times. still does nothing.</dd>
                <dt>oilpaint - <span>actions: ['oilpaint']</span></dt>
                <dd>an effect that will make the image look like an oil painting, accepts no arguments</dd>
                <dt>psychedelic - <span>actions: ['psychedelic']</span></dt><dd>trip out an image. takes no arguments. may be applied multiple times.</dd>
                <dt>rotate - <span>actions: [{'rotate': -45}]</span></dt>
                <dd>rotate an image by some number of degrees, takes a single numeric argument</dd>
                <dt>scale - <span>actions: [{'scale': {'maxwidth':320, 'maxheight': 320}}]</span></dt>
                <dd>
                    downscale an image preserving aspect ratio. you may provide the integer arguments 
                    maxwidth and/or maxheight which limit the image in the specified direction. units are pixels.
                </dd>
                <dt>sepia - <span>actions: ['sepia']</span></dt>
                <dd>sepia tone an image. no arguments.</dd>
                <dt>solarize - <span>['solarize']</span></dt>
                <dd>solarize an image. no arguments</dd>
                <dt>swirl - <span>actions: [{'swirl', 180}]</span></dt>
                <dd>
                    swirl an image. optionally a numeric argument specifies the degrees to swirl, 
                    default is 90 degrees.
                </dd>
            </dl>
        </dd>
    </dl>
</div>

<script>
YUI({combine: true, timeout: 10000}).use('anim', function(Y) {

    var OrigFileHandle = null;
    var ThumbFileHandle = null;
    var ListsAreHidden = true;
    var ApplyText = "Click on a transformation to add it";
    var DropImageText = "Drop Image Now";
    var DragImageText = "Drag Image from Desktop"
    var BP = BrowserPlus;
    var Services = [
        {service: "DragAndDrop", version: "1"},
        {service: "ImageAlter",  version: "4.0.2"},
        {service: "FileAccess",  version: "1.0.9"}
    ];
    var Transformations = {
        'a_trast_more':  { 'label': 'More Contrast', 'action':{'contrast': 1}},
        'a_trast_less':  { 'label': 'Less Contrast', 'action':{'contrast': -1}},
        'a_despeckle':   { 'label': 'Despeckle',     'action':'despeckle'},
        'a_enhance':     { 'label': 'Enhance',       'action':'enhance'},
        'a_grayscale':   { 'label': 'Grayscale',     'action':'grayscale'},
        'a_negate':      { 'label': 'Negate',        'action':'negate'},
        'a_oilpaint':    { 'label': 'OilPaint',      'action':'oilpaint'},
        'a_psychedelic': { 'label': 'Psychedelic',   'action':'psychedelic'},
        'a_rot_left':    { 'label': 'Rotate Left',   'action':{'rotate': -90}},
        'a_rot_right':   { 'label': 'Rotate Right',  'action':{'rotate': 90}},
        'a_sepia':       { 'label': 'Sepia',         'action':'sepia'},
        'a_solarize':    { 'label': 'Solarize',      'action':'solarize'},
        'a_swirl':       { 'label': 'Swirl',         'action':{'swirl': 90}}
    };
    


    function fireActionChange() {
        var actions = [];
        Y.Node.all('#apply li').each(function(v,k) {
            actions.push(v.getAttribute('action'));
        });

        Y.fire('actions:change', actions);
        
    }

    function renderActions(actions) {
        var arr = [];
        for(var k in actions) {
            if (actions.hasOwnProperty(k)) {
                arr.push(Transformations[actions[k]].action);
            }
        }

        processImage(ThumbFileHandle, arr);
    }
    
    // User click on item in apply list.  Remove it and fire action listener.
    function applyListClicked(e) {
        if (e.target.get('tagName') === "LI") {
            e.target.remove();
            fireActionChange();
            if (Y.Node.all('#apply li').size() === 0) {
                Y.one('#apply').append('<div id="applytext">' + ApplyText + '</div>');
            }
        }
    }

    function chooseListClicked(e) {
        if (e.target.get('tagName') === "LI") {
            var id = e.target.get('id');
            var d = Transformations[e.target.get('id')];

            var node = Y.Node.get("#applytext");
            if (node) {
                node.remove();
            }

            node = Y.Node.create('<li class="list2">' + Transformations[id].label + '</li>');
            node.setAttribute('action', id);
            Y.one('#apply').appendChild(node);
            fireActionChange();
        }
    }

    function error(str, res) {
        alert(str + ":" + res.error + " - " + res.verboseError);
    }

    function processImage(file, actions) {
        if (!file) {return;}
        
        BP.ImageAlter.transform({"file": file, "quality": 100, "actions": actions||[]}, function (transform) {
            if (transform.success) {
                BP.FileAccess.GetURL({ file: transform.value.file }, function (r) {
                    if (r.success) {
                        var w = transform.value.width, h = transform.value.height;
                        Y.one("#image").setContent('<img src="' + r.value + '" width="' + w + '" height="' + h + '">');
                        Y.one("#imagetext").setContent("");
                    }
                });
            }
        });
    }

    function isImage(file) {
        var i, len = file.mimeType.length, mime;
        for (i = 0; i < len; i++) {
            mime = file.mimeType[i];
            if (mime === "image/jpeg" || mime === "image/pjpeg" || mime === "image/gif" || mime === "image/png") {
                return true;
            }
        }
        return false;
    }

    function dragDrop(res) {
        var files = res.actualSelection, i, len = files.length;
        for (i = 0; i < len; i++) {
            if (isImage(files[i])) {

                OrigFileHandle = files[i];
                if (ListsAreHidden) {
                    ListsAreHidden = !ListsAreHidden;
                    var anim = new Y.Anim({node: '#lists', to: { opacity: 1 } });
                    anim.run();
                }

                // scale image to 320x320 and use that result for all further processing
                var params = {
                    "file": files[i],
                    "quality": 100,
                    "actions": [{"scale": {"maxwidth": 320, "maxheight": 320}}]
                };

                BP.ImageAlter.transform(params, function (transform) {
                    if (transform.success) {
                        // ThumbFileHandle has module scope
                        ThumbFileHandle = transform.value.file;
                        processImage(ThumbFileHandle);
                        Y.Node.all('#apply li').each(function(v,k) {
                            v.remove();
                        });
                    }
                });

                break;
            }
        }
    }

    function dragHover(over) {
        Y.one("#imagetext").setContent(over ? DropImageText : DragImageText);
    }


    Y.on("click", chooseListClicked, "#choose");
    Y.on("click", applyListClicked, "#apply");
    Y.on("actions:change", renderActions);
    Y.one("#applytext").setContent(ApplyText);

    // Populate list of files from the local Transformation object
    Y.each(Transformations, function(v, k) {
        Y.one("#choose").appendChild(Y.Node.create('<li id="' + k + '" class="list1">' + Transformations[k].label + '</li>'));
    });


    // Initialize BrowserPlus
    BPTool.Installer.show({}, function(init) {
        if (init.success) {
            BP.require({services: Services}, function(require) {
                if (require.success) {
                    BP.DragAndDrop.AddDropTarget({id: "imagewell", includeGestureInfo:true}, function(adt) {
                        // set initial text in Image box
                        dragHover(false);
                        BP.DragAndDrop.AttachCallbacks({ id: "imagewell", hover: dragHover, drop: dragDrop}, function(){});
                    });
                } else {
                    error("Error Loading Services", require);
                }
            });
        } else {
            error("Failed to initialize BrowserPlus", init);
        }
    }); 
});
</script>
</div>
</body>
</html>
